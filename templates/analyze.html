<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    {% include '_header.html' %}
    <div class="container p-4">
        <div class="flex flex-col sm:flex-row gap-4 mb-8 p-6 rounded-lg shadow-xl bg-[var(--card-bg-color)] border border-[var(--border-color)]">
            <input type="text" id="symbolInput" placeholder="Enter stock symbol (e.g., TSLA, SPY)" class="flex-grow px-5 py-3 border border-[var(--border-color)] rounded-lg text-base bg-[var(--bg-color)] text-[var(--text-color)] transition-colors duration-200 focus:border-[var(--accent-color)] focus:ring-2 focus:ring-[var(--accent-color)] outline-none">
            <button id="analyzeButton" class="px-8 py-3 bg-[#e94560] text-white rounded-lg cursor-pointer text-base font-semibold shadow-md transition-all duration-200 hover:bg-opacity-90 hover:scale-105">Analyze</button>
        </div>
        <div class="text-center p-4 mb-8 text-[var(--subtle-text-color)] text-sm bg-[var(--card-bg-color)] rounded-lg shadow-md" id="statusMessage">Enter a symbol and click Analyze to begin.</div>
        <div class="bg-[var(--card-bg-color)] p-8 rounded-lg shadow-xl border border-[var(--border-color)] min-h-[500px] prose" id="outputArea">
            <!-- Analysis report will be rendered here -->
        </div>
    </div>

    <footer class="mt-auto p-4 text-center text-[var(--subtle-text-color)] text-sm">
        <p>&copy; 2025 AI Stock Analyst. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let fullMarkdownContent = '';

        document.getElementById('analyzeButton').addEventListener('click', function() {
            const symbol = document.getElementById('symbolInput').value.toUpperCase();
            const outputArea = document.getElementById('outputArea');
            const statusMessage = document.getElementById('statusMessage');

            outputArea.innerHTML = ''; 
            fullMarkdownContent = ''; 
            statusMessage.textContent = 'Connecting to server...';
            statusMessage.className = 'status-message';

            if (!symbol) {
                statusMessage.textContent = 'Please enter a stock symbol.';
                return;
            }

            const eventSource = new EventSource(`/analyze/${symbol}`);

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.status === 'info') {
                    statusMessage.textContent = data.message;
                } else if (data.status === 'ai_chunk') {
                    fullMarkdownContent += data.content;
                    outputArea.innerHTML = marked.parse(fullMarkdownContent);
                } else if (data.status === 'complete') {
                    statusMessage.textContent = 'Analysis complete!';
                    eventSource.close();
                } else if (data.status === 'error') {
                    statusMessage.className = 'text-center p-4 mb-8 text-[var(--subtle-text-color)] text-sm bg-[var(--card-bg-color)] rounded-lg shadow-md text-[var(--accent-color)] font-bold';
                    statusMessage.textContent = `Error: ${data.message}`;
                    eventSource.close();
                }
            };

            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                statusMessage.className = 'status-message error-message';
                statusMessage.textContent = 'Connection error. Please try again.';
                eventSource.close();
            };
        });
    </script>
</body>
</html>